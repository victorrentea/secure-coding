<html>

<head>
    <meta charset="UTF-8"/>
    <script type="text/javascript" src="jquery-1.12.2.min.js"></script>
    <script type="text/javascript" src="toastr.min.js"></script>
    <link href="toastr.min.css" rel="stylesheet"/>
</head>

<body>

<h2>Browser-only Login</h2>

<div id="oauthstatus">Logging in...</div>
<p>
    /api/user/current:
    <div id="currentUser"></div>
</p>
<!--<button onclick="login()">Login from SPA</button>-->

<script type="text/javascript" src="http://localhost:8180/auth/js/keycloak.js"></script>
<script>
    let keycloak = null;

    function keycloakLoginAsSPA() {
        keycloak = new Keycloak();
        oauthstatus.innerText = "Loading...";
        keycloak.init({
            onLoad: "login-required",
            // Client > advanced settings > Proof Key for Code Exchange Code Challenge Method > S256
            pkceMethod: 'S256'
        }).then(function(authenticated) {
            if (authenticated) {
                oauthstatus.innerText = '✅ Authenticated as user: "'+ keycloak.idTokenParsed.preferred_username +
                    '", with email in IDToken: ' + keycloak.idTokenParsed.email;
                console.log("idToken", keycloak.idTokenParsed)
                console.log("accessToken", keycloak.tokenParsed)
                console.log("refreshToken", keycloak.refreshTokenParsed)
                fetchCurrentUser();
            } else {
                oauthstatus.innerText = '❌ NOT authenticated';
            }
        }).catch(function(e) {
            oauthstatus.innerText = '❌ ERROR (see console)';
            console.log(e);
        });
    }
    keycloakLoginAsSPA();
</script>
<script>
    function fetchCurrentUser() {
        $.ajax("http://localhost:8080/api/user/current", {
            method: "GET",
            headers: {
                "Authorization": "Bearer " + keycloak.token
            },
            success: function (user) {
                currentUser.innerText = "✅" + JSON.stringify(user);
            },
            error: function (e) {
                currentUser.innerText = "❌error: " + e;
                console.log(e);
            }
        });
    }

    function transferAmount() {
        $.ajax("http://localhost:8080/api/victim/transfer-rest", {
            method: "POST",
            // xhrFields: { withCredentials: true }, // CORS sending credentials
            data: JSON.stringify({
                recipientFullName: $("#fullName").val(),
                recipientIban: $("#iban").val(),
                amount: $("#amount").val()
            }),
            contentType: "application/json",
            headers: {
                "Authorization": "Bearer "+ keycloak.token
            },
            success: function (trainings) {
                toastr.success("Money Transferred")
            },
            error: function (e) {
                toastr.error("Error: " + e)
                console.log(e);
            }
        });
    }
</script>

<input type="button" value="Transfer (with Authorization Token)" onclick="transferAmount()">

</body>
</html>

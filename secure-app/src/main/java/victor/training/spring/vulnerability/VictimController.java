package victor.training.spring.vulnerability;

import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.*;

@Slf4j
@RestController
@RequestMapping("api/victim")
public class VictimController {
  public record MoneyTransferRequest(
      String recipientFullName,
      String recipientIban,
      int amount) {}

  // CSRF = in tab#2 evil website tricks user to send a <form> POST to victim host - browser attaches session cookie
  @PostMapping("transfer-form")
  public String formPost(@ModelAttribute MoneyTransferRequest request) {
    log.warn("Transfer via <form> POST {}", request);
    return "Done";
  }

  @GetMapping("transfer-over-get-BAD")
  public String get(MoneyTransferRequest request) { // fields are extract from request parameters: ?name=..&iban=..
    log.warn("Transferring via GET {}", request);
    return "Done";
  }

  // CORS is required by SPA loaded from CDN
  @PostMapping("transfer-rest")
//  @CrossOrigin(originPatterns = "http://localhost:8081", allowCredentials = "true") // only for NODE
//  @CrossOrigin(originPatterns = "http://*", allowCredentials = "true") // OMG!
  public void ajax(@RequestBody MoneyTransferRequest request) {
    log.warn("Transferring via REST {}", request);
  }
}


package victor.training.spring.vulnerability;

import jakarta.persistence.*;
import lombok.Data;
import lombok.RequiredArgsConstructor;
import org.springframework.boot.context.event.ApplicationStartedEvent;
import org.springframework.context.event.EventListener;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

import static jakarta.persistence.CascadeType.PERSIST;
import static java.util.stream.Collectors.toList;

@RequiredArgsConstructor
@RestController
public class DataExposure {
  private final BlogArticleRepo repo;

  public record BlogListDto(long id, String title) {
    public static BlogListDto fromEntity(BlogArticle entity) {
      return new BlogListDto(entity.getId(), entity.getTitle());
    }

  }

  @GetMapping("api/vulnerability/articles")
  public List<BlogListDto> getAllArticles() {
    return repo.findAll().stream().map(BlogListDto::fromEntity).collect(toList());
  }

  @GetMapping("api/vulnerability/articles/{id}")
  public BlogArticle article(@PathVariable Long id) {
    return repo.findById(id).orElseThrow();
  }

  //<editor-fold desc="Initial Data">
  @Transactional
  @EventListener(ApplicationStartedEvent.class)
  public void insertData() {
    for (int i = 0; i < 4; i++) {
      repo.save(new BlogArticle()
          .setTitle("Article #" + i)
          .setText(i + " Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor, inspect the JSON response data used to fill this page." + i)
          .setDate(LocalDate.now().minusDays(2))
          .setComments(List.of(
              new BlogArticleComment()
                  .setText("I like to move it!")
                  .setAuthor(new BlogUser()
                      .setName("King Julian")
                      .setEmail("kj@madagascar.com")),
              new BlogArticleComment()
                  .setText("Elementary")
                  .setAuthor(new BlogUser()
                      .setName("Sherlock")
                      .setEmail("sherlock.private@gmail.com"))
          ))
      );
    }
  }
  //</editor-fold>
}

@Data
@Entity
class BlogArticle {
  @Id
  @GeneratedValue
  private Long id;
  private String title;
  private String text;
  private LocalDate date;
  @OneToMany(cascade = PERSIST)
  private List<BlogArticleComment> comments = new ArrayList<>();
}

@Entity
@Data
class BlogArticleComment {
  @Id
  @GeneratedValue
  private Long id;
  private String text;
  @ManyToOne(cascade = PERSIST)
  private BlogUser author;
}

@Data
@Entity
class BlogUser {
  @Id
  @GeneratedValue
  private Long id;
  private String name;
  private String email;
}
// #1: @JsonIgnore - don't serialize this field
// #2: return Dto instead of Domain Entity üëç
// #3: @VisibleForRole("ROLE_ADMIN") on Dto field - clear field for non-admins

interface BlogArticleRepo extends JpaRepository<BlogArticle, Long> {
}

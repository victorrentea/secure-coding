package victor.training.spring.vulnerability;

import lombok.Data;
import lombok.RequiredArgsConstructor;
import org.mapstruct.Mapper;
import org.mapstruct.MappingTarget;
import org.springframework.boot.context.event.ApplicationStartedEvent;
import org.springframework.context.event.EventListener;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.*;

import jakarta.persistence.Entity;
import jakarta.persistence.Id;

import static org.mapstruct.NullValuePropertyMappingStrategy.IGNORE;

@RestController
@RequiredArgsConstructor
public class MassAssignment {
  private final PlayerRepo playerRepo;
  private final PlayerMapper mapper;

  @GetMapping("api/vulnerability/player/details")
//  public PlayerDetailsResponseDto getPlayerDetails() {‚úÖ
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è DO NOT REUSE DTOs between APIs!
  public PlayerDto getPlayerDetails() {
    Player entity = playerRepo.findById(getCurrentPlayerId()).orElseThrow();
    return mapper.toDto(entity);
  }

  //<editor-fold desc="SOLUTION">
  //  @Data
//  public static class UpdatePlayerDetailsCommand {
//    private String fullName;
//    private String country;
//  }
  //</editor-fold>

//  @PatchMapping("api/vulnerability/player/details")// evilüòà
  @PutMapping("api/vulnerability/player/details")
  @Transactional
//  public void updatePlayerDetails(@RequestBody UpdatePlayerRequestDto dto) {‚úÖ
  public void updatePlayerDetails(@RequestBody PlayerDto dto) {//‚ùå
    Player entity = playerRepo.findById(getCurrentPlayerId()).orElseThrow();
    dto.setCash(null);
    mapper.update(entity, dto);
  }
  private static long getCurrentPlayerId() {
    return SecurityContextHolder.getContext().getAuthentication().getName().equals("user") ?
            1L : 3L;
  }
  //<editor-fold desc="initial data">
  @EventListener(ApplicationStartedEvent.class)
  public void insertInitialPlayers() {
    playerRepo.save(new Player().setId(1L).setCountry("RO").setUsername("ipopescu").setCash(100).setFullName("Ion Popescu"));
    playerRepo.save(new Player().setId(2L).setCountry("NL").setUsername("snoah").setCash(250).setFullName("Saar Noah"));
    playerRepo.save(new Player().setId(3L).setCountry("BE").setUsername("jdoe").setCash(150).setFullName("John Doe"));
  }
  //</editor-fold>
}
@Data
class PlayerDto {
  private Long id;
  private String username;
  private String fullName;
  private String country;
  private Integer cash;
}

@Mapper(componentModel = "spring",
        nullValuePropertyMappingStrategy = IGNORE)
      // if a field is null in source (=Dto), leave it unchanged in target (=Entity),
      // instead of setting it to null
interface PlayerMapper {
  PlayerDto toDto(Player entity);
  void update(@MappingTarget Player entity, PlayerDto dto); // FIXME don't copy all fields
}


@Entity
@Data
class Player {
  @Id
  private Long id;
  private String username;
  private String fullName;
  private String country;
  private Integer cash;

}

interface PlayerRepo extends JpaRepository<Player, Long> {
}
package victor.training.spring.vulnerability;

import lombok.extern.slf4j.Slf4j;
import org.apache.commons.io.IOUtils;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import jakarta.annotation.PostConstruct;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;

@Slf4j
@RestController
public class Upload {

  public static final File IN_FOLDER = new File("in/");

  @PostMapping("api/vulnerability/upload")
  public String upload(@RequestParam String fileName, @RequestParam MultipartFile file) throws IOException {
    log.debug("Uploading file name={} size={}", fileName, file.getSize());
    // #1 sanitizezi sa nu contina .. nici / nici peste 255 char
    // #2 fileName actual pe disk sa nu fie arbitrar decis de use ci upload-<uuid>.dat
//    if (fileName.contains("..") || fileName.contains(File.pathSeparator)) { // blacklisting
    if (!fileName.matches("[a-zA-Z0-9\\-._]")) { // whitelisting = stronger
      throw new IllegalArgumentException("Gotcha!");
    }
    File targetFile = new File(IN_FOLDER, fileName);
    System.out.println("Writing the file to " + targetFile.getAbsolutePath());
    try (FileOutputStream outputStream = new FileOutputStream(targetFile)) {
      IOUtils.copy(file.getInputStream(), outputStream);
    }
    return "DONE: Successfully uploaded the user file at " + targetFile.getAbsolutePath();
  }



  @GetMapping("api/vulnerability/vulnerable-file-name")
  public String getVulnerableFileNameForDemo() {
    return IN_FOLDER.toPath()
            .relativize(new File("pom.xml").toPath()).toString();
  }

  @PostConstruct
  public void createInFolder() {
    IN_FOLDER.mkdir();
    if (!IN_FOLDER.isDirectory()) {
      throw new IllegalArgumentException("Should be a directory: " + IN_FOLDER.getAbsolutePath());
    }

  }

}
